<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§æŠ½å¥–ç³»ç»Ÿ-å°Šäº«ç‰ˆ</title>
    <style>
        /* --- å…¨å±€åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-source: url('èƒŒæ™¯.jpg');
            --main-title-font: "Microsoft YaHei";
            --main-title-size: 60px;
            --main-title-color: #ffffff;
            --main-title-weight: bold;
            --box-bg: rgba(255, 255, 255, 0.1);
            --box-border-w: 2px;
            --box-w: 800px;
            --box-h: 300px;
            --btn-bg: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
            --btn-border-w: 1px;
            --btn-w: 240px;
            --btn-h: 60px;
            --roll-style: normal;
            --win-style: italic;
            --list-show: block;
        }

        * { box-sizing: border-box; transition: all 0.2s ease-out; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }

        /* --- å‰å°ç•Œé¢ --- */
        #frontend {
            position: relative; width: 100%; height: 100%;
            background: var(--bg-source) no-repeat center center;
            background-size: cover; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1;
        }

        #title-container { text-align: center; margin-bottom: 30px; }
        #main-title { 
            font-size: var(--main-title-size); color: var(--main-title-color); 
            font-weight: var(--main-title-weight); font-family: var(--main-title-font);
            margin: 0; text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #sub-title { color: rgba(255,255,255,0.8); margin-top: 10px; font-size: 20px; }

        /* æŠ½å¥–ç›’ */
        #lottery-box {
            width: var(--box-w); height: var(--box-h);
            border: var(--box-border-w) solid rgba(255,255,255,0.3);
            background: var(--box-bg); border-radius: 20px;
            backdrop-filter: blur(15px); display: flex; align-items: center;
            justify-content: center; overflow: hidden; margin-bottom: 40px;
        }
        .slot-container { display: flex; justify-content: space-around; width: 100%; padding: 0 20px; }
        .name-slot { 
            flex: 1; text-align: center; color: white; font-size: 3.5rem; 
            font-weight: bold; text-shadow: 0 0 10px rgba(0,0,0,0.3); 
        }

        /* æŠ½å¥–æ–‡å­—çŠ¶æ€ */
        .rolling-text { font-style: var(--roll-style); opacity: 0.8; filter: blur(1px); }
        .winner-text { 
            font-style: var(--win-style); color: #fff;
            text-shadow: 0 0 20px #fff, 0 0 30px #ff00de; 
            animation: winPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes winPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1.2); opacity: 1; }
        }

        /* æŠ½å¥–æŒ‰é’® */
        #draw-btn {
            width: var(--btn-w); height: var(--btn-h);
            border: var(--btn-border-w) solid rgba(255,255,255,0.4);
            background: var(--btn-bg); color: white; border-radius: 50px;
            cursor: pointer; font-size: 1.5rem; display: flex; align-items: center;
            justify-content: center; gap: 12px; backdrop-filter: blur(5px);
        }
        #draw-btn:hover { border-color: white; transform: scale(1.05); background: rgba(255,255,255,0.3); }

        /* ä¸­å¥–åå•åˆ—è¡¨ */
        #round-history {
            margin-top: 30px; width: 80%; max-height: 150px; overflow-y: auto;
            display: var(--list-show); color: white; text-align: center;
            scrollbar-width: none;
        }
        .history-item { 
            background: rgba(0,0,0,0.2); margin-bottom: 5px; padding: 8px; 
            border-radius: 5px; font-size: 14px; animation: fadeIn 0.5s;
        }

        /* --- åå°ç•Œé¢ --- */
        #backend-icon {
            position: fixed; bottom: 20px; left: 20px; font-size: 28px;
            cursor: pointer; z-index: 1000; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }
        #backend-panel {
            position: fixed; bottom: 70px; left: 20px; width: 450px; max-height: 80vh;
            background: rgba(255,255,255,0.98); border-radius: 15px; padding: 25px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5); z-index: 999;
            display: none; flex-direction: column; overflow-y: auto; color: #333;
        }
        .setting-group { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .setting-group h3 { margin: 0 0 12px 0; font-size: 16px; color: #007bff; border-left: 4px solid #007bff; padding-left: 10px; }
        label { display: block; font-size: 12px; margin-bottom: 5px; font-weight: bold; color: #666; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; }
        .hint { font-size: 11px; color: #999; margin-top: -10px; margin-bottom: 10px; display: block; }
        .flex-row { display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-green { background: #28a745; color: white; }
        .btn-red { background: #dc3545; color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="frontend">
    <div id="title-container">
        <h1 id="main-title">å¹´åº¦ç››å…¸å¤§æŠ½å¥–</h1>
        <div id="sub-title">è®©å¥½è¿åœ¨è¿™ä¸€åˆ»å‘ç”Ÿ</div>
    </div>

    <div id="lottery-box">
        <div class="slot-container" id="slot-container">
            </div>
    </div>

    <button id="draw-btn" onclick="toggleDraw()">
        <span id="cfg-btn-icon-disp">ğŸ</span>
        <span id="draw-btn-text">å¼€å§‹æŠ½å¥–</span>
    </button>

    <div id="round-history">
        </div>
</div>

<div id="backend-icon" onclick="togglePanel()">âš™ï¸</div>

<div id="backend-panel">
    <div class="setting-group">
        <h3>1. æ ‡é¢˜ä¸èƒŒæ™¯å®šåˆ¶</h3>
        <label>ä¸»/å‰¯æ ‡é¢˜æ–‡å­—</label>
        <input type="text" id="in-m-title" value="å¹´åº¦ç››å…¸å¤§æŠ½å¥–" oninput="liveUpdate()">
        <input type="text" id="in-s-title" value="è®©å¥½è¿åœ¨è¿™ä¸€åˆ»å‘ç”Ÿ" oninput="liveUpdate()">
        <label>æ ‡é¢˜æ ·å¼ (å¤§å°/é¢œè‰²/å­—ä½“)</label>
        <div class="flex-row">
            <input type="number" id="in-m-size" value="60" oninput="liveUpdate()">
            <input type="color" id="in-m-color" value="#ffffff" oninput="liveUpdate()">
            <select id="in-m-font" onchange="liveUpdate()">
                <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                <option value="SimHei">é»‘ä½“</option>
                <option value="KaiTi">æ¥·ä½“</option>
            </select>
        </div>
        <label>ç½‘é¡µèƒŒæ™¯ (é»˜è®¤: èƒŒæ™¯.jpg)</label>
        <input type="text" id="in-bg" value="url('èƒŒæ™¯.jpg')" oninput="liveUpdate()">
        <span class="hint">è¾“å…¥ url('å›¾ç‰‡åœ°å€') æˆ–æ¸å˜å¦‚ linear-gradient(45deg, #f00, #00f)</span>
    </div>

    <div class="setting-group">
        <h3>2. éŸ³ä¹é…ç½®</h3>
        <label>æŠ½å¥–éŸ³ä¹ (éŸ³ä¹1.mp3) / éŸ³é‡</label>
        <div class="flex-row">
            <input type="text" id="in-mu1" value="éŸ³ä¹1.mp3">
            <input type="range" id="in-vol1" min="0" max="1" step="0.1" value="0.6">
        </div>
        <label>ä¸­å¥–éŸ³ä¹ (éŸ³ä¹2.mp3) / éŸ³é‡</label>
        <div class="flex-row">
            <input type="text" id="in-mu2" value="éŸ³ä¹2.mp3">
            <input type="range" id="in-vol2" min="0" max="1" step="0.1" value="0.8">
        </div>
        <span class="hint">ä¸­å¥–éŸ³ä¹3ç§’åè‡ªåŠ¨æ·¡å‡ºåœæ­¢ã€‚</span>
    </div>

    <div class="setting-group">
        <h3>3. åŒºåŸŸä¸æŒ‰é’®æ ·å¼</h3>
        <label>æŠ½å¥–åŒº (å®½/é«˜/è¾¹æ¡†/èƒŒæ™¯)</label>
        <div class="flex-row">
            <input type="number" id="in-box-w" value="800" oninput="liveUpdate()">
            <input type="number" id="in-box-h" value="300" oninput="liveUpdate()">
            <input type="number" id="in-box-b" value="2" oninput="liveUpdate()">
        </div>
        <select id="in-box-bg" onchange="liveUpdate()">
            <option value="rgba(255,255,255,0.1)">è¶…é€æ˜ç£¨ç ‚</option>
            <option value="rgba(0,0,0,0.5)">åŠé€æ·±æ²‰é»‘</option>
            <option value="linear-gradient(rgba(255,255,255,0.2), transparent)">ä¸Šè‡³ä¸‹æ¸å˜</option>
        </select>
        <label>æŒ‰é’® (å›¾æ ‡/å®½/é«˜/æ¸å˜èƒŒæ™¯)</label>
        <div class="flex-row">
            <select id="in-btn-icon" onchange="liveUpdate()">
                <option value="ğŸ">ğŸ ç¤¼ç‰©</option><option value="ğŸ”¥">ğŸ”¥ ç«çƒ­</option><option value="â­">â­ æ˜Ÿæ˜Ÿ</option><option value="âš™ï¸">âš™ï¸ é½¿è½®</option>
            </select>
            <input type="number" id="in-btn-w" value="240" oninput="liveUpdate()">
            <input type="number" id="in-btn-h" value="60" oninput="liveUpdate()">
        </div>
        <select id="in-btn-bg" onchange="liveUpdate()">
            <option value="linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05))">é»˜è®¤é€æ˜</option>
            <option value="linear-gradient(45deg, #ff416c, #ff4b2b)">çƒ­åŠ›æ¸å˜çº¢</option>
            <option value="linear-gradient(45deg, #2193b0, #6dd5ed)">æ¸…çˆ½æ¸å˜è“</option>
        </select>
        <label>ä¸­å¥–åå•æ˜¾ç¤ºæ§åˆ¶</label>
        <select id="in-list-show" onchange="liveUpdate()">
            <option value="block">æ˜¾ç¤ºåå•</option>
            <option value="none">éšè—åå•</option>
        </select>
    </div>

    <div class="setting-group">
        <h3>4. åå•å¯¼å…¥ä¸é€»è¾‘</h3>
        <label>åŒæ—¶æŠ½å¥–äººæ•°</label>
        <input type="number" id="in-draw-count" value="1" min="1" max="10" oninput="initSlots()">
        <label>åå•å¯¼å…¥ (é€—å·éš”å¼€)</label>
        <textarea id="in-names" rows="4">é™ˆæ˜,ç‹å¼º,æèŠ³,å¼ ä¼Ÿ,èµµæ•,å­™æ°,å‘¨æ¶›,å´ç£Š,éƒ‘æ´,å†¯å¹³,è¤šå«,å«å,è’‹äº‘,æ²ˆéœ,éŸ©æ¢…,æ¨ç«‹,æœ±å‹‡,ç§¦ä¸½,å°¤æ–‡,è®¸åš</textarea>
        <span class="hint">è§„åˆ™ï¼šæ”¯æŒä¸­æ–‡ï¼Œæœ€é«˜500äººã€‚å·²ä¸­å¥–çš„äººå‘˜ä¸ä¼šå†æ¬¡ä¸­å¥–ã€‚</span>
        <div class="flex-row">
            <button class="action-btn btn-green" onclick="saveNames()">ä¿å­˜åå•å¹¶é‡ç½®</button>
        </div>
    </div>

    <div class="setting-group">
        <h3>5. è®°å½•ç®¡ç†</h3>
        <label>ä¸­å¥–è®°å½•ç®¡ç†</label>
        <div id="backend-record-list" style="font-size: 11px; background:#f4f4f4; padding:5px; max-height:80px; overflow-y:auto;">æ— è®°å½•</div>
        <div class="flex-row" style="margin-top:10px;">
            <button class="action-btn btn-red" onclick="resetLottery()">å…¨ç³»ç»Ÿé‡ç½®</button>
        </div>
    </div>
</div>

<audio id="audio-bg" loop></audio>
<audio id="audio-win"></audio>

<script>
    let pool = [];      // æ€»åå•
    let available = []; // å‰©ä½™å¯æŠ½åå•
    let winners = [];   // æ€»ä¸­å¥–è€…åå•
    let currentRoundWinners = [];
    let isRolling = false;
    let timer = null;
    let currentRound = 1;

    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        saveNames();
        liveUpdate();
        initSlots();
    };

    function togglePanel() {
        const p = document.getElementById('backend-panel');
        p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
    }

    // --- å®æ—¶è”åŠ¨æ›´æ–° ---
    function liveUpdate() {
        const r = document.documentElement;
        // æ ‡é¢˜
        document.getElementById('main-title').innerText = document.getElementById('in-m-title').value;
        document.getElementById('sub-title').innerText = document.getElementById('in-s-title').value;
        r.style.setProperty('--main-title-size', document.getElementById('in-m-size').value + 'px');
        r.style.setProperty('--main-title-color', document.getElementById('in-m-color').value);
        r.style.setProperty('--main-title-font', document.getElementById('in-m-font').value);
        r.style.setProperty('--bg-source', document.getElementById('in-bg').value);

        // æŠ½å¥–ç›’
        r.style.setProperty('--box-w', document.getElementById('in-box-w').value + 'px');
        r.style.setProperty('--box-h', document.getElementById('in-box-h').value + 'px');
        r.style.setProperty('--box-border-w', document.getElementById('in-box-b').value + 'px');
        r.style.setProperty('--box-bg', document.getElementById('in-box-bg').value);

        // æŒ‰é’®
        r.style.setProperty('--btn-w', document.getElementById('in-btn-w').value + 'px');
        r.style.setProperty('--btn-h', document.getElementById('in-btn-h').value + 'px');
        r.style.setProperty('--btn-bg', document.getElementById('in-btn-bg').value);
        document.getElementById('cfg-btn-icon-disp').innerText = document.getElementById('in-btn-icon').value;
        document.getElementById('backend-icon').innerText = document.getElementById('in-btn-icon').value;

        // åå•æ˜¾ç¤º
        r.style.setProperty('--list-show', document.getElementById('in-list-show').value);
    }

    function initSlots() {
        const count = parseInt(document.getElementById('in-draw-count').value);
        const container = document.getElementById('slot-container');
        container.innerHTML = '';
        for(let i=0; i<count; i++) {
            const slot = document.createElement('div');
            slot.className = 'name-slot';
            slot.innerText = 'ï¼Ÿ';
            container.appendChild(slot);
        }
    }

    function saveNames() {
        const text = document.getElementById('in-names').value;
        pool = text.split(/[,ï¼Œ\n]/).map(n => n.trim()).filter(n => n !== "");
        available = [...pool];
        winners = [];
        currentRound = 1;
        document.getElementById('round-history').innerHTML = '';
        document.getElementById('backend-record-list').innerText = 'åå•å·²åŠ è½½ï¼Œå…±' + pool.length + 'äºº';
        initSlots();
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    function toggleDraw() {
        const count = parseInt(document.getElementById('in-draw-count').value);
        const btnText = document.getElementById('draw-btn-text');
        const aBg = document.getElementById('audio-bg');
        const aWin = document.getElementById('audio-win');

        if (!isRolling) {
            // å¼€å§‹æŠ½å¥–
            if (available.length < count) {
                alert("å¯ç”¨äººå‘˜ä¸è¶³ï¼è¯·åœ¨åå°é‡ç½®åå•ã€‚");
                return;
            }

            isRolling = true;
            btnText.innerText = "åœæ­¢æŠ½å¥–";
            
            // éŸ³ä¹1ï¼šæŠ½å¥–ä¸­
            aBg.src = document.getElementById('in-mu1').value;
            aBg.volume = document.getElementById('in-vol1').value;
            aBg.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾å—é˜»"));

            const slots = document.querySelectorAll('.name-slot');
            timer = setInterval(() => {
                slots.forEach(slot => {
                    const randomIndex = Math.floor(Math.random() * available.length);
                    slot.innerText = available[randomIndex];
                    slot.className = "name-slot rolling-text";
                });
            }, 80);

        } else {
            // ç»“æŸæŠ½å¥–
            isRolling = false;
            btnText.innerText = "å¼€å§‹æŠ½å¥–";
            clearInterval(timer);

            // éŸ³ä¹æ§åˆ¶ï¼šéŸ³ä¹1åœï¼ŒéŸ³ä¹2å“
            aBg.pause();
            aBg.currentTime = 0;
            
            aWin.src = document.getElementById('in-mu2').value;
            aWin.volume = document.getElementById('in-vol2').value;
            aWin.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾å—é˜»"));

            // éŸ³é‡æ¸å‡åœ
            setTimeout(() => {
                let vol = aWin.volume;
                const fade = setInterval(() => {
                    if (vol > 0.05) {
                        vol -= 0.05;
                        aWin.volume = vol;
                    } else {
                        aWin.pause();
                        aWin.volume = document.getElementById('in-vol2').value;
                        clearInterval(fade);
                    }
                }, 100);
            }, 2500);

            // ç»“æœæŠ½å–
            currentRoundWinners = [];
            const slots = document.querySelectorAll('.name-slot');
            for(let i=0; i<count; i++) {
                const winIdx = Math.floor(Math.random() * available.length);
                const pick = available.splice(winIdx, 1)[0];
                currentWinnersUpdate(pick, slots[i], i);
            }

            // æ›´æ–°å†å²è®°å½•
            addHistory(currentRoundWinners);
            currentRound++;
        }
    }

    function currentWinnersUpdate(name, dom, index) {
        currentRoundWinners.push(name);
        winners.push(name);
        dom.innerText = name;
        dom.className = "name-slot winner-text";
    }

    function addHistory(list) {
        // å‰å°æ˜¾ç¤º
        const history = document.getElementById('round-history');
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerText = `ç¬¬ ${currentRound} è½®ä¸­å¥–è€…: ${list.join('ã€')}`;
        history.prepend(item);

        // åå°è®°å½•
        const rec = document.getElementById('backend-record-list');
        if (rec.innerText.includes('äºº')) rec.innerHTML = '';
        rec.innerHTML += `<div>è½®æ¬¡${currentRound}: ${list.join(',')}</div>`;
    }

    function resetLottery() {
        if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰æŠ½å¥–æ•°æ®å—ï¼Ÿï¼ˆä¸ä¼šä¸­å¥–çš„äººå°†å¯ä»¥å†æ¬¡ä¸­å¥–ï¼‰")) {
            saveNames();
            alert("ç³»ç»Ÿå·²å…¨é‡é‡ç½®ã€‚ä¸­å¥–è€…åå•å·²æ¶ˆé™¤ã€‚");
        }
    }
</script>
</body>
</html>